<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 화면</title>
    <link rel="stylesheet" href="/css/user/login.css?v=2.0" />
</head>
<script src="/js/user/login.js"></script>
<body>
    <main class="card">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>로그인</h1>
            <p class="sub">계정 정보를 입력해 주세요.</p>
          </div>
        </div>
    
        <!-- 알림 -->
        <div th:if="${param.error}" class="alert" role="alert">아이디 또는 비밀번호를 확인해주세요.</div>
        <div th:if="${param.logout}" class="alert ok" role="alert">안전하게 로그아웃되었습니다.</div>
    
        <!-- 로그인 폼 -->
        <form th:action="@{/users/login}" method="post" novalidate>
          <label for="username">아이디</label>
          <input id="username" name="username" type="text" placeholder="id" autocomplete="username" autofocus required />
    
          <label for="password">비밀번호</label>
          <input id="password" name="password" type="password" placeholder="••••••••" autocomplete="current-password" required />
    
          <div class="row">
            <label class="remember">
              <input id="remember-me" name="remember-me" type="checkbox" />
              로그인 상태 유지
            </label>
            <a class="links pwdReset" href="#" aria-disabled="true" style="margin-left:auto;font-size:12px;">비밀번호를 잊어버리셨나요?</a>
          </div>
    
          <!-- CSRF 
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
          <button class="btn" type="submit">로그인</button>
    
          <div class="links">
            <span></span>
            <a th:href="@{/users/joinForm}">회원가입</a>
          </div>
        </form>

        
          <!-- 모달 배경 + 모달 1 -->
          <div id="modalBackdrop" class="modal-backdrop hidden">

            <!-- 모달 1: 사용자 정보 확인 -->
            <div id="findUserModal" class="modal-box hidden">
                <h3 style="margin:0 0 10px 0;font-size:16px;">비밀번호 찾기</h3>

                <input type="text" id="name" placeholder="이름">
                <input type="text" id="sabun" placeholder="사번">

                <button id="checkUserBtn" class="modal-btn">다음</button>
                <p id="findUserError" style="color:red; display:none; font-size:12px;">일치하는 사용자가 없습니다.</p>
                <button class="close-btn" onclick="closeModal()">닫기</button>
            </div>

            <!-- 모달 2: 비밀번호 재설정 -->
            <div id="resetPasswordModal" class="modal-box hidden">
              <form th:action="@{/users/passWordReset}" method="post" novalidate>
                <h3 style="margin:0 0 10px 0;font-size:16px;">새 비밀번호 설정</h3>

                <input type="password" name="password" id="newPw" placeholder="새 비밀번호">
                <input type="password" id="newPw2" placeholder="비밀번호 확인">
                
                <!-- 유저 확인용 -->
                <input type="hidden" name="name" id="hiddenName">
                <input type="hidden" name="sabun" id="hiddenSabun">

                <button type="submit" id="resetPwBtn" class="modal-btn">비밀번호 변경</button>
                <button class="close-btn" onclick="closeModal()">닫기</button>
              </form>
            </div>
          </div>
        <div class="footer">© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}"></span> KSCompany</div>

<script>
  const backdrop = document.getElementById("modalBackdrop");
  const modal1 = document.getElementById("findUserModal");
  const modal2 = document.getElementById("resetPasswordModal");
  
  document.querySelector(".pwdReset").addEventListener("click", () => {
      backdrop.classList.remove("hidden");
      modal1.classList.remove("hidden");
  });
  
  // 닫기 버튼
  function closeModal() {
    backdrop.classList.add("hidden");
    modal1.classList.add("hidden");
    modal2.classList.add("hidden");
  }
  
  document.getElementById("checkUserBtn").addEventListener('click', async () => {
    const name = document.getElementById("name").value.trim();
    const sabun = document.getElementById("sabun").value.trim();
  
    const response = await fetch("/users/findByUsers", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({name: name, sabun: sabun})
    });
  
    const data = await response.text();
  
    if (data === "success") {
      modal1.classList.add("hidden");
      modal2.classList.remove("hidden");
      
      document.getElementById("hiddenName").value = name;
      document.getElementById("hiddenSabun").value = sabun;
    } else {
      document.getElementById("findUserError").style.display = "block";
    }
  });
</script>
</body>
</html>